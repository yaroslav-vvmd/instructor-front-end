<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W89SWKCG" height="0" width="0"
        style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.21.0/jquery.validate.min.js"
    integrity="sha512-KFHXdr2oObHKI9w4Hv1XPKc898mE4kgYx58oqsc/JqqdLMDI4YjOLzom+EMlW8HFUd0QfjfAvxSL6sEq/a42fQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js"
    integrity="sha512-efAcjYoYT0sXxQRtxGY37CKYmqsFVOIwMApaEbrxJr4RwqVVGw8o+Lfh/+59TU07+suZn1BWq4fDl5fdgyCNkw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    const firebaseConfig = {
        apiKey: "AIzaSyDCYeAn0HZAcwKGc11tQiUn52fC_l3MPEs",
        authDomain: "instructor-feb0c.firebaseapp.com",
        projectId: "instructor-feb0c",
        storageBucket: "instructor-feb0c.appspot.com",
        messagingSenderId: "197967930036",
        appId: "1:197967930036:web:b4523d7819e9759288ade1 ",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); // Get the auth object
    const db = getFirestore(app);
    window.auth = auth;

    const showHeaderButton = (isAuth) => {
        if (isAuth) {
            $('#login-btn').addClass("hidden");
            $('#login-mobile-btn').addClass("hidden");
            $('#logout-btn').removeClass("hidden");
            $('#logout-mobile-btn').removeClass("hidden");
            $('#logout-btn').addClass("visible");
            $('#logout-mobile-btn').addClass("visible");
            $('#user-controls').addClass("visible");
            $('#profile-link').addClass("visible");

        } else {
            $('#logout-btn').addClass("hidden");
            $('#logout-mobile-btn').addClass("hidden");
            $('#login-btn').removeClass("hidden");
            $('#login-mobile-btn').removeClass("hidden");
            $('#login-btn').addClass("visible");
            $('#login-mobile-btn').addClass("visible");
            $('#user-controls').removeClass("visible");
            $('#profile-link').removeClass("visible");

        }
    };

    onAuthStateChanged(auth, async (user) => {
        const isAuth = !!user;
        showHeaderButton(isAuth);

        if (!isAuth) {
            localStorage.removeItem("uid");
            localStorage.removeItem("userData");
            await getUserCity();
            return;
        }

        localStorage.setItem("uid", user.uid);

        const userDocRef = doc(db, "users", user.uid);

        try {
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                const firstName = userData.firstName || "";
                const lastName = userData.lastName || "";
                const email = userData.email || "";
                const role_autoschool = userData.role_autoschool || "";
                const role_instructor = userData.role_instructor || "";
                const newsletter = userData.newsletter || "";
                const city = userData.city || "";

                const userDataObject = {
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    role_instructor: role_instructor,
                    role_autoschool: role_autoschool,
                    newsletter: newsletter,
                    city: city,
                };
                localStorage.setItem("userData", JSON.stringify(userDataObject));
                document.querySelector('.user-controls_name').textContent = firstName + ' ' + lastName;
            } else {
                console.log("No such document!");
            }
        } catch (error) {
            console.error("Error fetching user data:", error);
        }

        getUserCity();
    });


    //Detect user city
    function updateUserCity(_city) {
        const uid = localStorage.getItem('uid');

        if (!uid) {
            console.error('Помилка: користувач не авторизований');
            return;
        }

        fetch("https://instructor-back-end.vercel.app/update-user", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                uid: uid,
                city: _city
            }),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.error('Помилка:', error);
            });
    }

    const updateCityInfo = (_city, _showCityModal = true) => {
        const cityTextElements = document.querySelectorAll('[data-current-city-text]');
        const instructorsCitySelect = document.querySelector('[data-city-select="instructors"]');
        const schoolsCitySelect = document.querySelector('[data-city-select="schools"]');
        const citySelect = schoolsCitySelect ? schoolsCitySelect : instructorsCitySelect;
        const cityModal = document.getElementById('city-modal');
        const rejectBtn = document.getElementById('city-modal-reject-btn');
        const confirmBtn = document.getElementById('city-modal-confirm-btn');

        if (!citySelect) {
            console.warn('Немає селекту з містами');
            return;
        }

        const hideModal = () => {
            cityModal?.classList.add('is-disappear');
            setTimeout(() => {
                cityModal?.classList.remove('is-disappear');
                cityModal?.classList.remove('is-visible');
            }, 400);
        };

        const selectCity = (_citySelect, _cityName) => {
            const linkTextEls = _citySelect.querySelectorAll('.select_link-text');
            const toggle = _citySelect.querySelector('.w-dropdown-toggle');
            const list = _citySelect.querySelector('.w-dropdown-list');
            const arrowIcon = _citySelect.querySelector('.arrow-icon');

            linkTextEls.forEach(linkText => {
                if (linkText.textContent.trim().toUpperCase() === _cityName.toUpperCase()) {
                    toggle.classList.add('is-unfocused');
                    const parentItem = linkText.closest('.select_item');
                    if (window.location.pathname === "/") {
                        parentItem?.click();
                    }
                    setTimeout(() => {
                        toggle.classList.remove('w--open');
                        toggle.setAttribute('aria-expanded', 'false');
                        list.classList.remove('w--open');
                        toggle?.blur();
                    }, 10);
                    setTimeout(() => {
                        toggle.classList.remove('is-unfocused');
                    }, 1000);
                }
            });
        };

        const currentCity = _city || localStorage.getItem('currentCity');
        const citySlug = currentCity.split(' ').join('-');
        const cityOptions = citySelect.querySelectorAll('option');
        let cityName = 'Київ';

        let pagePathname = window.location.pathname.toUpperCase();

        cityOptions.forEach(option => {
            if (option.value.toUpperCase().includes(citySlug.toUpperCase())) {
                cityName = option.innerText;
                return;
            }
        });

        if (_showCityModal && cityModal) {
            cityTextElements.forEach(element => {
                element.textContent = cityName;
                cityModal?.classList.add('is-visible');
            });

            rejectBtn.addEventListener('click', () => {
                hideModal();
                sessionStorage.setItem('doNotShowCityModal', true);
                const userConfirmedCity = localStorage.getItem('userConfirmedCity');

                if (userConfirmedCity) {

                    const confirmedCitySlug = userConfirmedCity.split(' ').join('-');
                    const confirmedCityOptions = citySelect.querySelectorAll('option');
                    let confirmedCityName = 'Київ';

                    cityOptions.forEach(option => {
                        if (option.value.toUpperCase().includes(confirmedCitySlug.toUpperCase())) {
                            confirmedCityName = option.innerText;
                            return;
                        }
                    });

                    selectCity(citySelect, confirmedCityName);

                    sessionStorage.setItem('doNotShowCityModal', true);

                    console.log('Останнє місто з userData: ', userConfirmedCity);
                } else if (!pagePathname.includes('CITY-')) {
                    const citySelectToggle = citySelect.querySelector('.w-dropdown-toggle');
                    const citySelectList = citySelect.querySelector('.w-dropdown-list');
                    const citySelectArrowIcon = citySelect.querySelector('.arrow-icon');

                    citySelect.style.zIndex = '901';
                    citySelectToggle.classList.add('w--open');
                    citySelectToggle.setAttribute('aria-expanded', 'true');
                    citySelectList.classList.add('w--open');
                    arrowIcon.style.transform = 'translate3d(0px, 0px, 0px) scale3d(1, 1, 1) rotateX(0deg) rotateY(0deg) rotateZ(180deg) skew(0deg, 0deg)';
                }
            });

            confirmBtn.addEventListener('click', () => {
                hideModal();

                if (instructorsCitySelect) {
                    selectCity(instructorsCitySelect, cityName);
                }

                if (schoolsCitySelect) {
                    selectCity(schoolsCitySelect, cityName);
                }

                updateUserCity(currentCity);
                localStorage.setItem('currentCity', currentCity);
            });

        } else if (!pagePathname.includes(citySlug.toUpperCase()) && !pagePathname.includes('CITY-')) {
            if (instructorsCitySelect) {
                selectCity(instructorsCitySelect, cityName);
            }
            if (schoolsCitySelect) {
                selectCity(schoolsCitySelect, cityName);
            }
            localStorage.setItem('currentCity', currentCity);
        }
    };

    const getLocation = async () => {
        try {
            let userIp = null;

            const ipResponse = await fetch("https://api.ipify.org?format=json");
            if (!ipResponse.ok) throw new Error('IP fetch failed');

            const { ip } = await ipResponse.json();
            userIp = ip;

            console.log('IP: ' + userIp);

            const response = await fetch(`https://instructor-back-end.vercel.app/location?ip=${userIp}`);
            if (!response.ok) throw new Error('Location fetch failed');

            const data = await response.json();
            const { city } = data?.location || {};

            if (city) {
                localStorage.setItem('currentCity', city);
            }
        } catch (error) {
            console.error('Error fetching location data:', error.message);
        }
    };

    const getUserCity = async () => {
        console.log('');
        console.log('/ ----------- Визначення міста: Start ----------- /');

        const storageUserData = localStorage.getItem('userData');
        const doNotShowCityModal = sessionStorage.getItem('doNotShowCityModal');
        let userCity = storageUserData ? JSON.parse(storageUserData).city?.trim() : null;

        if (!doNotShowCityModal) {
            let currentCity = localStorage.getItem('currentCity');

            if (userCity) {
                console.log('Місто береться з userData: ', userCity);
                localStorage.setItem('userConfirmedCity', userCity);
            }

            await getLocation();
            const newCityFromIP = localStorage.getItem('currentCity');

            if (newCityFromIP) {
                if (currentCity && newCityFromIP.toUpperCase() !== currentCity.toUpperCase()) {
                    console.log('** IP user`а змінився **');
                    localStorage.setItem('currentCity', newCityFromIP);
                }

                if (!userCity || newCityFromIP.toUpperCase() !== userCity.toUpperCase()) {
                    console.log('Вибране місто по IP: ', newCityFromIP);
                    updateCityInfo(newCityFromIP);
                } else {
                    console.log('Місто залишається тим самим: ', userCity);
                    updateCityInfo(userCity, false);
                }
            } else {
                console.log('Місто визначається по геолокації або з localStorage');
                updateCityInfo(currentCity);
            }

            console.log('Останнє місто: ' + currentCity);
            console.log('Поточне місто: ' + newCityFromIP);
        } else {
            if (userCity) {
                console.log('Місто береться з userData: ', userCity);
                localStorage.setItem('userConfirmedCity', userCity);
                updateCityInfo(userCity, false);
            }
        }

        console.log('/ ----------- Визначення міста: End ----------- /');
        console.log('');
    };


</script>

<script>
    function updateUserControlsName() {
        const userData = localStorage.getItem("userData");

        if (userData) {
            try {
                // Show/hide appropriate buttons
                $('#login-btn').addClass("hidden");
                $('#login-mobile-btn').addClass("hidden");
                $('#logout-btn').removeClass("hidden").addClass("visible");
                $('#logout-mobile-btn').removeClass("hidden").addClass("visible");
                $('#user-controls').addClass("visible");
                $('#profile-link').addClass("visible");

                const userDataObject = JSON.parse(userData);
                const { firstName, lastName } = userDataObject;

                if (firstName && lastName) {
                    const userNameElement = document.querySelector('.user-controls_name');

                    if (userNameElement) {
                        // Set initial width to current width
                        userNameElement.style.width = userNameElement.offsetWidth + "px";

                        // Temporarily set the width to auto to measure new content size
                        userNameElement.style.transition = "width 0.5s ease";
                        userNameElement.textContent = `${firstName} ${lastName}`;
                        userNameElement.style.width = "auto";

                        // Use reflow to calculate the new width
                        const newWidth = userNameElement.scrollWidth + "px";

                        requestAnimationFrame(() => {
                            userNameElement.style.width = newWidth; // Apply the new width smoothly
                        });
                    }
                }
            } catch (error) {
                console.error("Error parsing userData from localStorage:", error);
            }
        }
    }

    document.addEventListener("DOMContentLoaded", updateUserControlsName);
</script>


<script type="module">
    import { signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const logOut = async () => {
        await signOut(window.auth).then(() => {
            window.location.href = `https://${window.location.hostname}`;
            console.log("Користувач успішно вийшов з системи");
        }).catch((error) => {
            console.error("Помилка при виході з системи:", error);
        })
    }

    $('#logout-btn').on("click", logOut);
    $('#logout-mobile-btn').on("click", logOut);
    $('#logout-modal-confirm').on("click", logOut);
</script>


<script>
    (function () {
        const sessionKey = "sharedSession"; // Key to track the session
        const tabsKey = "activeTabs"; // Key to track active tabs

        // Increment active tabs counter when a tab is opened
        localStorage.setItem(tabsKey, (parseInt(localStorage.getItem(tabsKey) || "0") + 1).toString());

        // Set session data if it doesn't exist
        if (!localStorage.getItem(sessionKey)) {
            localStorage.setItem(sessionKey, JSON.stringify({ subscribedServices: [] }));
        }

        // Listen for tab close event
        window.addEventListener("beforeunload", () => {
            const activeTabs = parseInt(localStorage.getItem(tabsKey) || "1") - 1;
            localStorage.setItem(tabsKey, activeTabs.toString());

            // Clear session data if this is the last tab
            if (activeTabs === 0) {
                localStorage.removeItem(sessionKey);
            }
        });

        // Utility to access/update the session
        const getSession = () => JSON.parse(localStorage.getItem(sessionKey));
        const updateSession = (data) => localStorage.setItem(sessionKey, JSON.stringify(data));

        // Modify your handleSubscription function
        window.handleSubscription = async (slug) => {
            const session = getSession();
            const subscribedServices = session.subscribedServices;

            if (subscribedServices.includes(slug)) {
                console.log(`User already subscribed to ${slug} during this session.`);
                return;
            }

            try {
                const response = await fetch(
                    `https://instructor-backend.vercel.app/services/${slug}/subscribers`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                    }
                );
                if (!response.ok) {
                    throw new Error(`Failed to increment subscribers for ${slug}`);
                }

                // Update subscription counts
                updateSubscriptionCounts();

                // Update session data
                subscribedServices.push(slug);
                updateSession({ ...session, subscribedServices });
            } catch (error) {
                console.error("Error incrementing subscribers:", error);
            }
        };
    })();
</script>

<script src="https://yaroslav-vvmd.github.io/instructor-front-end/site-settings.js"></script>